<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: Tahoma; padding: 15px; }
        .lesson-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 10px; border-right: 6px solid #0d6efd; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lesson-card.done { border-right-color: #198754; background: #f0fff4; }
    </style>
</head>
<body>
    <div class="container" style="max-width: 450px;">
        <h5 class="text-center mb-4 fw-bold">ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡</h5>
        <div id="lessonList">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡...</div>
        
        <div id="compBox" class="d-none mt-4 p-3 bg-white rounded-4 border">
            <h6 class="fw-bold text-primary">â• Ø¨Ø§Ú©Ø³ Ø¬Ø¨Ø±Ø§Ù†ÛŒ</h6>
            <input type="text" id="extraBook" class="form-control" placeholder="Ù†Ø§Ù… Ú©ØªØ§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...">
        </div>

        <div class="mt-4 p-3 bg-white rounded-4 border">
            <label class="small text-muted">ØªØ§ÛŒÙ… Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ø¯Ù‚ÛŒÙ‚Ù‡):</label>
            <input type="number" id="mobile" class="form-control text-center mb-3">
            <label class="small text-muted">Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø®ÙˆØ¯:</label>
            <input type="range" class="form-range" id="satSelf" min="1" max="10">
        </div>

        <button class="btn btn-primary w-100 py-3 mt-4 rounded-pill fw-bold" onclick="finalSave()">Ø«Ø¨Øª Ùˆ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ ğŸš€</button>
    </div>

    <div id="vModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000;">
        <div class="bg-white p-4 rounded-5 w-75 text-center shadow-lg">
            <h6 id="vTitle" class="fw-bold"></h6>
            <input type="number" id="vInput" class="form-control form-control-lg text-center my-4">
            <button class="btn btn-primary w-100 rounded-pill py-2" onclick="confirmV()">ØªØ§ÛŒÛŒØ¯</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiFk6ICEcvTV63XQImvN3lSgOA2AdtjihEl-8xZmHyi97l4qd0zADmqRn8nnrwcQDj/exec";
        const profile = JSON.parse(localStorage.getItem("profile"));
        let plan = [], specSum = 0, genSum = 0, activeIdx = null;

        window.onload = async () => {
            const res = await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:"getDailyData", username:profile.username, week:5, dayName:"Ø´Ù†Ø¨Ù‡"})});
            const data = await res.json();
            plan = data.plan;
            if(data.hasComp) document.getElementById('compBox').classList.remove('d-none');
            render();
        };

        function render() {
            document.getElementById('lessonList').innerHTML = plan.map((l, i) => `
                <div class="lesson-card d-flex justify-content-between align-items-center" id="c-${i}" onclick="openM(${i})">
                    <span><b>${l.time}</b> | ${l.cleanName}</span>
                    <span id="s-${i}">âšª</span>
                </div>`).join('');
        }

        function openM(i) {
            activeIdx = i;
            document.getElementById('vTitle').innerText = plan[i].isGen ? "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„ Ø¹Ù…ÙˆÙ…ÛŒ" : "ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª ØªØ®ØµØµÛŒ";
            document.getElementById('vModal').style.display = 'flex';
        }

        function confirmV() {
            const v = parseInt(document.getElementById('vInput').value) || 0;
            if(plan[activeIdx].isGen) genSum += v; else specSum += v;
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±ØªÚ©Ø³
            let stats = JSON.parse(localStorage.getItem('today_stats') || '{}');
            stats[plan[activeIdx].time] = v;
            localStorage.setItem('today_stats', JSON.stringify(stats));

            document.getElementById(`c-${activeIdx}`).classList.add('done');
            document.getElementById(`s-${activeIdx}`).innerText = 'âœ…';
            document.getElementById('vModal').style.display = 'none';
        }

        async function finalSave() {
            const reportData = {
                action: "saveReport", username: profile.username, week: 5,
                mobile: document.getElementById('mobile').value,
                extra: document.getElementById('extraBook').value,
                testSpec: specSum, testGen: genSum, // Ø§ÛŒÙ† Ø¯Ùˆ Ø¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ø± Ø³ØªÙˆÙ† Ù…Ø§Ø±Ú©Ø¯Ø§Ø± Ù‡Ù… Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                satSelf: document.getElementById('satSelf').value,
                studySpec: 0, studyGen: 0, examScore: 0, satConsult: 10, habits: ""
            };
            await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify(reportData)});
            alert("Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø´ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
            location.href = "index.html";
        }
    </script>
</body>
</html>
