<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ | Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø¯Ú©ØªØ± Ø§ÙØ´Ø§Ø±Ù…Ù†Ø´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        @font-face { font-family: 'Doran'; src: url('fonts/DoranFaNum-Regular.ttf'); }
        body { background-color: #f4f7f6; font-family: 'Doran', sans-serif; }
        
        /* Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª Ú¯Ø±Ø§Ø¯ÛŒØ§Ù†ØªÛŒ */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 7px; background: #eee; z-index: 2000; }
        .progress-bar-fill { 
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, #ff4b2b, #007bff, #ff416c); 
            background-size: 200% 100%; animation: gradientMove 2s linear infinite; transition: width 0.5s ease;
        }
        @keyframes gradientMove { 0% {background-position: 100% 0%;} 100% {background-position: -100% 0%;} }

        .step-card { display: none; background: white; border-radius: 25px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-top: 50px; }
        .step-card.active { display: block; animation: fadeInUp 0.4s ease; }
        @keyframes fadeInUp { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }

        .btn-nav { border-radius: 15px; padding: 15px; font-weight: bold; width: 100%; border: none; margin-top: 15px; }
        .btn-next { background: #007bff; color: white; }
        .btn-back { background: #f8f9fa; color: #666; border: 1px solid #ddd; }
        
        .lesson-chip { 
            display: inline-block; padding: 12px 18px; background: #f8f9fa; 
            border: 1.5px solid #eee; border-radius: 12px; margin: 5px; 
            cursor: pointer; transition: 0.2s; 
        }
        .lesson-chip.selected { background: #28a745; color: white; border-color: #218838; }
        
        .habit-option { border: 2px solid #f0f0f0; padding: 15px; border-radius: 15px; margin-bottom: 10px; cursor: pointer; }
        .habit-option.active { border-color: #007bff; background: #f0f7ff; }
    </style>
</head>
<body>

<div class="progress-container"><div id="main-progress" class="progress-bar-fill"></div></div>

<div class="container" style="max-width: 500px; padding-bottom: 50px;">
    
    <div id="step-1" class="step-card active text-center">
        <h4 class="mb-4">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØŒ <span id="user-name"></span></h4>
        <label class="mb-2">Ø´Ù…Ø§Ø±Ù‡ Ù‡ÙØªÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡:</label>
        <input type="number" id="weekNum" class="form-control text-center fs-4" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5">
        <button class="btn-nav btn-next" onclick="goToStep(2)">Ø´Ø±ÙˆØ¹ Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´</button>
    </div>

    <div id="step-2" class="step-card">
        <h4 class="mb-4 text-center">ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯Ø§Øª</h4>
        <div class="habit-option" onclick="this.classList.toggle('active')">â° Ø¨ÛŒØ¯Ø§Ø±ÛŒ Ø¨Ù‡â€ŒÙ…ÙˆÙ‚Ø¹</div>
        <div class="habit-option" onclick="this.classList.toggle('active')">ğŸ’ª ÙˆØ±Ø²Ø´</div>
        <div class="habit-option" onclick="toggleMobile(this)">ğŸ“± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
        <div id="mobile-box" class="d-none mt-2"><input type="number" id="mobileMin" class="form-control" placeholder="Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ØŸ"></div>
        <button class="btn-nav btn-next" onclick="goToStep(3)">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn-nav btn-back" onclick="goToStep(1)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-3" class="step-card">
        <h4 class="mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h4>
        <p class="small text-muted mb-4">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ù…Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:</p>
        <div id="lesson-list" class="text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§...</div>
        <button class="btn-nav btn-next mt-4" onclick="goToStep(4)">ØªØ§ÛŒÛŒØ¯ Ùˆ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn-nav btn-back" onclick="goToStep(2)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-4" class="step-card">
        <h4 class="mb-4">Ø¢Ù…Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ®ØµØµÛŒ</h4>
        <input type="number" id="studySpec" class="form-control mb-3" placeholder="Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ®ØµØµÛŒ">
        <input type="number" id="testSpec" class="form-control mb-3" placeholder="ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª ØªØ®ØµØµÛŒ">
        <button class="btn-nav btn-next" onclick="goToStep(5)">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn-nav btn-back" onclick="goToStep(3)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-5" class="step-card text-center">
        <h4 class="mb-5">Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</h4>
        <label>Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ø®ÙˆØ¯Øª:</label>
        <input type="range" class="form-range" min="1" max="5" id="satSelf" oninput="v1.innerText=this.value">
        <div class="h2 text-primary" id="v1">3</div>
        <button class="btn-nav btn-next mt-5" style="background:#28a745" onclick="submitFinal()">ğŸš€ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
        <button class="btn-nav btn-back" onclick="goToStep(4)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPDMFhYNd5_116jaHVYHuiKw7nl7ktD0GAQhZxNot8pT3R4flfF0yZgGXmCoy26s0W/exec";
    const profile = JSON.parse(localStorage.getItem("profile") || "{}");
    document.getElementById('user-name').innerText = profile.firstName || "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²";

    function goToStep(s) {
        document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
        document.getElementById('step-' + s).classList.add('active');
        document.getElementById('main-progress').style.width = ((s-1)/4 * 100) + '%';
        if(s === 3) loadBooksFromSheet();
    }

    function toggleMobile(el) {
        el.classList.toggle('active');
        document.getElementById('mobile-box').classList.toggle('d-none');
    }

    async function loadBooksFromSheet() {
        const container = document.getElementById('lesson-list');
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "getBooks",
                    field: profile.studyField,
                    grade: profile.gradeLevel
                })
            });
            const result = await res.json();
            container.innerHTML = "";
            result.lessons.forEach(lesson => {
                const chip = document.createElement('div');
                chip.className = 'lesson-chip';
                chip.innerText = lesson;
                chip.onclick = function() { this.classList.toggle('selected'); };
                container.appendChild(chip);
            });
        } catch(e) { container.innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§"; }
    }

    async function submitFinal() {
        // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ø§Ù† SCRIPT_URL Ø¨Ø§ Ø§Ú©Ø´Ù† saveReport
        alert("Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§ÙˆØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!");
        location.href = "index.html";
    }
</script>
</body>
</html>
