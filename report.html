<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ | Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø¯Ú©ØªØ± Ø§ÙØ´Ø§Ø±Ù…Ù†Ø´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        @font-face { font-family: 'Doran'; src: url('fonts/DoranFaNum-Medium.ttf'); }
        body { background-color: #f8f9fa; font-family: 'Doran', sans-serif; }
        
        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù†ØªÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #eee; z-index: 2000; }
        .progress-bar-fill { 
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, #ff4b2b, #007bff, #ff416c); 
            background-size: 200% 100%; animation: gradientMove 2s linear infinite; transition: width 0.5s ease;
        }
        @keyframes gradientMove { 0% {background-position: 100% 0%;} 100% {background-position: -100% 0%;} }

        .step-card { display: none; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-top: 50px; }
        .step-card.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        .btn-nav { border-radius: 12px; padding: 15px; font-weight: bold; width: 100%; border: none; margin-top: 10px; }
        .btn-next { background: #007bff; color: white; }
        .btn-back { background: #f1f3f5; color: #495057; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ø±ÙˆØ³ Ù…Ø·Ø§Ø¨Ù‚ ØªØµÙˆÛŒØ± 2727.jpg */
        .lesson-chip { 
            display: inline-block; padding: 10px 20px; background: white; 
            border: 1px solid #dee2e6; border-radius: 12px; margin: 6px; 
            cursor: pointer; transition: 0.2s; color: #495057;
        }
        .lesson-chip.selected { background: #e7f1ff; border-color: #007bff; color: #007bff; font-weight: bold; }
        
        .habit-btn { border: 2px solid #f1f3f5; padding: 15px; border-radius: 15px; margin-bottom: 10px; cursor: pointer; text-align: right; }
        .habit-btn.active { border-color: #007bff; background: #f8fbff; }
    </style>
</head>
<body>

<div class="progress-container"><div id="main-progress" class="progress-bar-fill"></div></div>

<div class="container" style="max-width: 500px; padding-bottom: 60px;">
    
    <div id="step-1" class="step-card active text-center">
        <h4 class="mb-4">Ø³Ù„Ø§Ù… <span id="user-display"></span> Ø¬Ø§Ù†ØŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ</h4>
        <label class="mb-2">Ø´Ù…Ø§Ø±Ù‡ Ù‡ÙØªÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:</label>
        <input type="number" id="weekNum" class="form-control form-control-lg text-center mb-4" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5">
        <button class="btn-nav btn-next" onclick="goToStep(2)">Ø´Ø±ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</button>
    </div>

    <div id="step-2" class="step-card">
        <h4 class="text-center mb-4">Ø±Ø¯ÛŒØ§Ø¨ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§</h4>
        <div class="habit-btn" onclick="this.classList.toggle('active')">â° Ø¨ÛŒØ¯Ø§Ø±ÛŒ Ø¨Ù‡â€ŒÙ…ÙˆÙ‚Ø¹</div>
        <div class="habit-btn" onclick="this.classList.toggle('active')">ğŸ’ª ÙˆØ±Ø²Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</div>
        <div class="habit-btn" id="mobile-trigger" onclick="toggleMobile(this)">ğŸ“± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
        <div id="mobile-input-box" class="d-none mb-3">
            <input type="number" id="mobileTime" class="form-control" placeholder="Ù…Ø¯Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)">
        </div>
        <button class="btn-nav btn-next" onclick="goToStep(3)">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn-nav btn-back" onclick="goToStep(1)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-3" class="step-card text-center">
        <h4 class="mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±ÙˆØ³ Ø§Ù…Ø±ÙˆØ²</h4>
        <p class="small text-muted mb-4">Ø¯Ø±ÙˆØ³ÛŒ Ú©Ù‡ Ø§Ù…Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:</p>
        <div id="lesson-grid">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±ÙˆØ³ Ù…Ø®ØµÙˆØµ Ø´Ù…Ø§...</div>
        <button class="btn-nav btn-next mt-4" onclick="goToStep(4)">ØªØ§ÛŒÛŒØ¯ Ø¯Ø±ÙˆØ³</button>
        <button class="btn-nav btn-back" onclick="goToStep(2)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-4" class="step-card">
        <h5 class="mb-4">Ø¢Ù…Ø§Ø± Ø¯Ø±ÙˆØ³ ØªØ®ØµØµÛŒ</h5>
        <input type="number" id="studySpec" class="form-control mb-3" placeholder="Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ®ØµØµÛŒ">
        <input type="number" id="testSpec" class="form-control mb-3" placeholder="ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª ØªØ®ØµØµÛŒ">
        <input type="number" id="markedSpec" class="form-control mb-3" placeholder="ØªØ³Øª Ù…Ø§Ø±Ú©Ø¯Ø§Ø± ØªØ®ØµØµÛŒ">
        <button class="btn-nav btn-next" onclick="goToStep(5)">Ø¨Ø¹Ø¯ÛŒ</button>
        <button class="btn-nav btn-back" onclick="goToStep(3)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-5" class="step-card text-center">
        <h5 class="mb-4">Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø§Ù…Ø±ÙˆØ²Øª (Û± ØªØ§ Ûµ)</h5>
        <input type="range" class="form-range mb-3" min="1" max="5" id="satSelf" oninput="v1.innerText=this.value">
        <div class="display-5 text-primary fw-bold mb-5" id="v1">3</div>
        
        <h5 class="mb-4">Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø´Ø§ÙˆØ± (Û± ØªØ§ Ûµ)</h5>
        <input type="range" class="form-range mb-3" min="1" max="5" id="satConsult" oninput="v2.innerText=this.value">
        <div class="display-5 text-success fw-bold" id="v2">3</div>

        <button class="btn-nav btn-next mt-4" style="background:#28a745" onclick="submitData()">ğŸš€ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
        <button class="btn-nav btn-back" onclick="goToStep(4)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMgZw_YbVgPf6kvK1gOdgtaQw2e7NhNQKOXbJBPFx1nYhzS2ZyP112FdNVZomSqkx0/exec"; // Ø¢Ø¯Ø±Ø³ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
    const profile = JSON.parse(localStorage.getItem("profile") || "{}");
    document.getElementById('user-display').innerText = profile.firstName || "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²";

    function goToStep(s) {
        document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
        document.getElementById('step-' + s).classList.add('active');
        document.getElementById('main-progress').style.width = ((s-1)/4 * 100) + '%';
        if(s === 3) fetchBooks();
    }

    function toggleMobile(el) {
        el.classList.toggle('active');
        document.getElementById('mobile-input-box').classList.toggle('d-none');
    }

    // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±ÙˆØ³ Ø§Ø² Ø´ÛŒØª Books Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ø´ØªÙ‡ Ùˆ Ù¾Ø§ÛŒÙ‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
    async function fetchBooks() {
        const grid = document.getElementById('lesson-grid');
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "getBooks",
                    field: profile.studyField,
                    grade: profile.gradeLevel
                })
            });
            const result = await res.json();
            grid.innerHTML = "";
            result.lessons.forEach(lesson => {
                const chip = document.createElement('div');
                chip.className = 'lesson-chip';
                chip.innerText = lesson;
                chip.onclick = function() { this.classList.toggle('selected'); };
                grid.appendChild(chip);
            });
        } catch(e) { grid.innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø´ÛŒØª Books"; }
    }

    async function submitData() {
        const selectedLessons = Array.from(document.querySelectorAll('.lesson-chip.selected')).map(el => el.innerText).join(' - ');
        const data = {
            action: "saveReport",
            username: profile.username,
            week: document.getElementById('weekNum').value,
            selectedLessons: selectedLessons,
            studySpec: document.getElementById('studySpec').value,
            testSpec: document.getElementById('testSpec').value,
            markedSpec: document.getElementById('markedSpec').value,
            satSelf: document.getElementById('satSelf').value,
            satConsult: document.getElementById('satConsult').value,
            mobileTime: document.getElementById('mobileTime').value || 0
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
            alert("Ø¢ÙØ±ÛŒÙ† " + profile.firstName + "! Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ø±ÙˆØ²Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
            location.href = "index.html";
        } catch(e) { alert("Ú¯Ø²Ø§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯."); location.href = "index.html"; }
    }
</script>
</body>
</html>
