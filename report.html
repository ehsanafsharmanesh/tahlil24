<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        @font-face { font-family: 'Doran'; src: url('fonts/DoranFaNum-Medium.ttf'); }
        body { background-color: #f8f9fa; font-family: 'Doran', sans-serif; }
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #eee; z-index: 2000; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff4b2b, #007bff, #ff416c); transition: width 0.5s ease; }
        .step-card { display: none; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-top: 50px; }
        .step-card.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
        .btn-nav { border-radius: 12px; padding: 15px; font-weight: bold; width: 100%; border: none; margin-top: 10px; }
        .btn-next { background: #007bff; color: white; }
        .btn-back { background: #f1f3f5; color: #495057; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ */
        .plan-item { background: #fff; border: 1px solid #eee; border-right: 5px solid #007bff; padding: 15px; border-radius: 15px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .plan-item.done { border-right-color: #28a745; background: #f0fff4; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>

<div class="progress-container"><div id="main-progress" class="progress-bar-fill"></div></div>

<div class="container" style="max-width: 500px; padding-bottom: 60px;">
    
    <div id="step-1" class="step-card active text-center">
        <h4 class="mb-4">Ø´Ø±ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´</h4>
        <label class="mb-2">Ù‡ÙØªÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡:</label>
        <input type="number" id="weekNum" class="form-control form-control-lg text-center mb-4" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5">
        <button class="btn-nav btn-next" onclick="goToStep(2)">Ø§Ø¯Ø§Ù…Ù‡</button>
    </div>

    <div id="step-2" class="step-card">
        <h5 class="text-center mb-4">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù…Ø±ÙˆØ² (Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª)</h5>
        <div id="plan-container" class="text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        
        <div id="comp-section" class="d-none mt-4 pt-3 border-top">
            <h6 class="text-primary small fw-bold">â• Ø¯Ø±Ø³ Ø¬Ø¨Ø±Ø§Ù†ÛŒ (Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡)</h6>
            <input type="text" id="extraBook" class="form-control" placeholder="Ù†Ø§Ù… Ú©ØªØ§Ø¨...">
        </div>
        
        <button class="btn-nav btn-next mt-4" onclick="goToStep(3)">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn-nav btn-back" onclick="goToStep(1)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="step-3" class="step-card text-center">
        <h5 class="mb-4">Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</h5>
        <label>Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ø®ÙˆØ¯ (Û±-Û±Û°):</label>
        <input type="range" class="form-range mb-4" min="1" max="10" id="satSelf">
        <label>Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ù…Ø´Ø§ÙˆØ± (Û±-Û±Û°):</label>
        <input type="range" class="form-range mb-4" min="1" max="10" id="satConsult">
        <label>ØªØ±Ø§Ø² Ø¢Ø²Ù…ÙˆÙ† (Ø§Ú¯Ø± Ø¯Ø§Ø´ØªÛŒØ¯):</label>
        <input type="number" id="examScore" class="form-control text-center mb-4" placeholder="0">

        <button class="btn-nav btn-next" style="background:#28a745" onclick="submitData()">ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´</button>
        <button class="btn-nav btn-back" onclick="goToStep(2)">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

</div>

<div id="qModal" class="modal-overlay">
    <div class="modal-box">
        <h5 id="modalTitle" class="fw-bold mb-3"></h5>
        <input type="number" id="testInput" class="form-control text-center mb-3" placeholder="ØªØ¹Ø¯Ø§Ø¯...">
        <button class="btn btn-primary w-100 rounded-3" onclick="confirmTest()">Ø«Ø¨Øª</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxsfbe4IcPNP9xcLtlfpvmN2SLkgycHLUSZMS8K3RgnlC98kyDRw-8rakmMYbb_Jnhq/exec";
    const profile = JSON.parse(localStorage.getItem("profile") || "{}");
    let dailyPlan = [];
    let specSum = 0, genSum = 0;
    let activeIndex = null;

    function goToStep(s) {
        document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
        document.getElementById('step-' + s).classList.add('active');
        document.getElementById('main-progress').style.width = ((s-1)/2 * 100) + '%';
        if(s === 2) loadDailyPlan();
    }

    async function loadDailyPlan() {
        const week = document.getElementById('weekNum').value;
        const grid = document.getElementById('plan-container');
        grid.innerHTML = '<div class="spinner-border text-primary"></div>';
        
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST', 
                body: JSON.stringify({ action: "getDailyData", username: profile.username, week: week, dayName: "Ø´Ù†Ø¨Ù‡" }) // Ø±ÙˆØ² Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ú©Ù†ÛŒØ¯
            });
            const data = await res.json();
            dailyPlan = data.plan;
            
            if(data.hasComp) document.getElementById('comp-section').classList.remove('d-none');
            
            grid.innerHTML = dailyPlan.map((l, i) => `
                <div class="plan-item" id="item-${i}" onclick="openModal(${i})">
                    <div class="text-end">
                        <small class="text-muted">${l.time}</small><br>
                        <strong>${l.cleanName}</strong>
                    </div>
                    <span id="badge-${i}">âšª</span>
                </div>
            `).join('');
            
        } catch(e) { grid.innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø±Ù†Ø§Ù…Ù‡"; }
    }

    function openModal(index) {
        activeIndex = index;
        const lesson = dailyPlan[index];
        document.getElementById('modalTitle').innerText = lesson.isGen ? "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„ Ø¹Ù…ÙˆÙ…ÛŒØŸ" : "ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª ØªØ®ØµØµÛŒØŸ";
        document.getElementById('qModal').style.display = 'flex';
        document.getElementById('testInput').value = '';
        document.getElementById('testInput').focus();
    }

    function confirmTest() {
        const val = parseInt(document.getElementById('testInput').value) || 0;
        if(dailyPlan[activeIndex].isGen) genSum += val;
        else specSum += val;

        // Ø°Ø®ÛŒØ±Ù‡ Ù„ÙˆÚ©Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú©Ø§Ø±ØªÚ©Ø³
        let stats = JSON.parse(localStorage.getItem('today_stats') || '{}');
        stats[dailyPlan[activeIndex].time] = val;
        localStorage.setItem('today_stats', JSON.stringify(stats));

        document.getElementById(`item-${activeIndex}`).classList.add('done');
        document.getElementById(`badge-${activeIndex}`).innerText = 'âœ…';
        document.getElementById('qModal').style.display = 'none';
    }

    async function submitData() {
        const data = {
            action: "saveReport",
            username: profile.username,
            week: document.getElementById('weekNum').value,
            studySpec: 0, studyGen: 0, // ÙØ¹Ù„Ø§ ØµÙØ± Ú†ÙˆÙ† Ú©Ø§Ø±Ø¨Ø± ÙÙ‚Ø· ØªØ³Øª ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡
            testSpec: specSum, 
            testGen: genSum,
            extraBook: document.getElementById('extraBook').value,
            examScore: document.getElementById('examScore').value || 0,
            satSelf: document.getElementById('satSelf').value,
            satConsult: document.getElementById('satConsult').value,
            mobileTime: 0, habits: "" // Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø² ØµÙØ­Ù‡ habits Ú¯Ø±ÙØª
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
            alert("Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
            location.href = "index.html";
        } catch(e) { alert("Ø«Ø¨Øª Ø´Ø¯."); location.href = "index.html"; }
    }
</script>
</body>
</html>
