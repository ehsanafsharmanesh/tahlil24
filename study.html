<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>پلنر تحصیلی - پنل کاربری</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{background:linear-gradient(135deg,#6a11cb,#2575fc);min-height:100vh;color:#fff}
    .container{max-width:800px}
    .glass-card{background:rgba(255,255,255,.15);backdrop-filter:blur(10px);border-radius:20px;padding:25px;border:1px solid rgba(255,255,255,.2)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    .btn-save{background:#ffc107;color:#000;font-weight:bold;border-radius:50px;padding:12px 30px;border:none;width:100%}
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="topbar glass-card">
      <span class="fw-bold">خوش آمدید، <span id="who">دانش‌آموز</span></span>
      <a href="index.html" class="btn btn-sm btn-outline-light">خروج</a>
    </div>

    <div class="glass-card mb-4">
      <h5 class="mb-4">ثبت فعالیت روزانه (ارتقای تحلیل)</h5>
      <div class="row g-3">
        <div class="col-6">
          <label class="form-label">ساعت مطالعه</label>
          <input type="number" id="studyHours" class="form-control" placeholder="مثلا 6">
        </div>
        <div class="col-6">
          <label class="form-label">تعداد تست</label>
          <input type="number" id="testCount" class="form-control" placeholder="مثلا 50">
        </div>
        <div class="col-12">
          <button id="saveBtn" class="btn btn-save">ذخیره و به‌روزرسانی تحلیل</button>
        </div>
      </div>
    </div>

    <div class="glass-card">
      <h5 class="mb-3">نمودار پیشرفت شما</h5>
      <canvas id="progressChart"></canvas>
    </div>
  </div>

  <script>
    // تنظیمات اتصال
    const API_BASE_URL = localStorage.getItem("planner_api"); // آدرس گوگل اپ اسکریپت
    const currentCode = localStorage.getItem("planner_code");
    document.getElementById("who").innerText = currentCode;

    // ۱. تابع بارگذاری اطلاعات از گوگل شیت
    async function loadData() {
      if(!API_BASE_URL) return;
      
      try {
        const response = await fetch(API_BASE_URL, {
          method: "POST",
          body: JSON.stringify({ action: "login", code: currentCode, password: "" }) // در سیستم جدید فقط کد کافیست
        });
        const result = await response.json();
        if(result.status === "success") {
          updateChart(result.history || []);
        }
      } catch (e) { console.error("خطا در بارگذاری:", e); }
    }

    // ۲. تابع ذخیره اطلاعات جدید
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const hours = document.getElementById("studyHours").value;
      const tests = document.getElementById("testCount").value;

      if(!hours || !tests) return alert("لطفا مقادیر را پر کنید");

      const newData = {
        date: new Date().toLocaleDateString('fa-IR'),
        hours: hours,
        tests: tests
      };

      document.getElementById("saveBtn").innerText = "در حال ذخیره...";

      try {
        await fetch(API_BASE_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "save",
            code: currentCode,
            newData: newData
          })
        });
        alert("اطلاعات با موفقیت ذخیره شد.");
        location.reload(); // بازنشانی صفحه برای نمایش داده جدید
      } catch (e) {
        alert("خطا در اتصال به سرور");
      }
    });

    // ۳. تابع رسم نمودار
    function updateChart(history) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      const labels = history.map(item => item.date);
      const data = history.map(item => item.hours);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ساعت مطالعه',
            data: data,
            borderColor: '#ffc107',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(255, 193, 7, 0.2)'
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } } }
        }
      });
    }

    // اجرای اولیه
    loadData();
  </script>
</body>
</html>
