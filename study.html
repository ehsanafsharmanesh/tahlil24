<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¯ÙØªØ±Ú†Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ | Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø¯Ú©ØªØ± Ø§ÙØ´Ø§Ø±Ù…Ù†Ø´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        /* Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ø§Ù† Ø§Ø² Ù¾ÙˆØ´Ù‡ fonts */
        @font-face {
            font-family: 'Doran';
            src: url('fonts/DoranFaNum-Light.ttf') format('truetype');
            font-weight: 300;
        }
        @font-face {
            font-family: 'Doran';
            src: url('fonts/DoranFaNum-Bold.ttf') format('truetype');
            font-weight: 700;
        }

        body { 
            background-color: #f8f9fa; 
            font-family: 'Doran', Tahoma, sans-serif; 
            font-weight: 300; 
        }
        
        .bold-text { font-weight: 700 !important; }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡ A4 Ø¹Ù…ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ†Øª */
        .page-container { 
            background: white; 
            width: 210mm; 
            min-height: 290mm; 
            margin: 20px auto; 
            padding: 30px 45px; 
            border: 1px solid #ddd;
            page-break-after: always; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1.5px solid #222; padding: 12px; text-align: center; vertical-align: middle; font-size: 15px; }
        th { background-color: #f2f2f2; font-weight: 700; }

        /* Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ù„Ø§ÛŒÙ… Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ */
        .bg-rest { background-color: #f0f7ff !important; color: #0056b3; } /* Ø¢Ø¨ÛŒ Ø¨Ø³ÛŒØ§Ø± Ù…Ù„Ø§ÛŒÙ… */
        .bg-exam { background-color: #f2faf2 !important; color: #1b5e20; } /* Ø³Ø¨Ø² Ø¨Ø³ÛŒØ§Ø± Ù…Ù„Ø§ÛŒÙ… */

        .stamp-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 30px; 
            border-top: 2px solid #222; 
            padding-top: 15px; 
        }
        
        .logo-img { width: 140px; }
        .no-print { background: white; padding: 25px; border-bottom: 3px solid #007bff; position: sticky; top: 0; z-index: 100; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page-container { margin: 0; border: none; width: 100%; height: auto; padding: 10mm; }
            @page { size: A4 portrait; margin: 0; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="container text-center">
        <h4 class="mb-3 bold-text">ØµØ¯ÙˆØ± Ø¯ÙØªØ±Ú†Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ (A4 Ø¹Ù…ÙˆØ¯ÛŒ)</h4>
        <div class="row justify-content-center g-2">
            <div class="col-md-3">
                <input type="text" id="weekInput" class="form-control text-center fs-5" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù…Ø«Ù„Ø§Ù‹ 05)">
            </div>
            <div class="col-md-auto">
                <button class="btn btn-primary px-4 bold-text" onclick="loadWeeklyData()">Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
                <button class="btn btn-success px-4 bold-text" onclick="handlePrint()">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ø¯ÙØªØ±Ú†Ù‡</button>
            </div>
        </div>
    </div>
</div>

<div id="print-content">
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby8NJAfUez3wCUiRXthdSuRT0thlXL_bPS2rDXGpcJhb25wdejrhKvMZ5DjxlZLv6Nh/exec";
    const studentCode = localStorage.getItem("planner_code") || "tahsili38";

    async function loadWeeklyData() {
        const weekNum = document.getElementById('weekInput').value;
        if(!weekNum) { alert("Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
        
        document.getElementById('print-content').innerHTML = "<div class='text-center mt-5'><div class='spinner-border text-primary'></div><p class='mt-2'>Ø¯Ø± Ø­Ø§Ù„ ØªØ±Ú©ÛŒØ¨ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ Ø³Ø§Ø®Øª ØµÙØ­Ø§Øª...</p></div>";
        
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "getWeekPlan", studentCode: studentCode, weekNum: weekNum })
            });
            const result = await res.json();
            
            if(result.status === "success") {
                renderPages(result.data, weekNum);
            } else {
                document.getElementById('print-content').innerHTML = "<p class='text-center text-danger mt-5'>Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.</p>";
            }
        } catch (e) {
            document.getElementById('print-content').innerHTML = "<p class='text-center text-danger mt-5'>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„! ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>";
        }
    }

    function renderPages(data, weekNum) {
        const container = document.getElementById('print-content');
        container.innerHTML = "";

        data.forEach((day) => {
            let html = `
                <div class="page-container">
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="bold-text" style="color:#003366;">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ² ${day.dayName}</h2>
                            <div class="text-end">
                                <div class="bold-text">Ù†Ø§Ù… Ø¯Ø§ÙˆØ·Ù„Ø¨: ${studentCode}</div>
                                <div>ØªØ§Ø±ÛŒØ®: ${day.date} | Ú©Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡: ${weekNum}</div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:25%">Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</th>
                                    <th>Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø·Ø§Ù„Ø¹Ù‡ / ÙØ¹Ø§Ù„ÛŒØª Ø¢Ù…ÙˆØ²Ø´ÛŒ</th>
                                    <th style="width:15%">ØªØ§ÛŒÛŒØ¯</th>
                                </tr>
                            </thead>
                            <tbody>`;

            // Ù…Ù†Ø·Ù‚ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø¯ØºØ§Ù… (Merge) Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ ÛŒØ§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ
            let mergedTasks = [];
            for (let i = 0; i < day.tasks.length; i++) {
                let current = day.tasks[i];
                let startTime = current.time.split('-')[0].trim();
                let endTime = current.time.split('-')[1]?.trim() || "";
                let lesson = current.lesson ? current.lesson.trim() : "";

                // Ø¨Ø±Ø±Ø³ÛŒ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ: Ø§Ú¯Ø± Ø¯Ø±Ø³ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯ ÛŒØ§ Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø§Ø¯ØºØ§Ù… Ú©Ù†
                while (i + 1 < day.tasks.length && (day.tasks[i + 1].lesson === current.lesson || !day.tasks[i + 1].lesson) && lesson !== "") {
                    endTime = day.tasks[i + 1].time.split('-')[1]?.trim() || day.tasks[i + 1].time.split('-')[0].trim();
                    i++;
                }
                mergedTasks.push({ time: `${startTime} - ${endTime}`, lesson: lesson });
            }

            mergedTasks.forEach(task => {
                let rowClass = "";
                if(task.lesson.includes("Ø§Ø³ØªØ±Ø§Ø­Øª")) rowClass = "bg-rest";
                if(task.lesson.includes("Ø¢Ø²Ù…ÙˆÙ†")) rowClass = "bg-exam";

                html += `
                    <tr class="${rowClass}">
                        <td class="bold-text" dir="ltr">${task.time}</td>
                        <td>${task.lesson}</td>
                        <td class="fs-4">${task.lesson && !task.lesson.includes("Ø§Ø³ØªØ±Ø§Ø­Øª") ? "âœ”ï¸" : ""}</td>
                    </tr>`;
            });

            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ ØµÙØ­Ù‡ ØªØ§ Û±Û° Ø±Ø¯ÛŒÙ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø¨ØµØ±ÛŒ
            const emptyCount = 10 - mergedTasks.length;
            for(let j=0; j < (emptyCount > 0 ? emptyCount : 2); j++) {
                html += `<tr style="height:45px"><td></td><td></td><td></td></tr>`;
            }

            html += `</tbody></table>
                    </div>
                    <div class="stamp-footer">
                        <div style="max-width:70%">
                            <strong class="bold-text">Ø¬Ù…Ù„Ù‡ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ Ù‡ÙØªÙ‡:</strong>
                            <p style="margin-top:8px; font-size:16px; line-height:1.6;">${day.quote || 'Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø¬Ù…ÙˆØ¹ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú©ÛŒ Ø§Ø³Øª Ú©Ù‡ Ù‡Ø± Ø±ÙˆØ² ØªÚ©Ø±Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.'}</p>
                        </div>
                        <div class="text-center">
                            <img src="https://raw.githubusercontent.com/ehsanafsharmanesh/ehsanafsharmanesh.github.io/main/newlogo.jpg" class="logo-img">
                            <div class="bold-text" style="font-size:13px; margin-top:5px;">Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø¯Ú©ØªØ± Ø§ÙØ´Ø§Ø±Ù…Ù†Ø´</div>
                        </div>
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }

    function handlePrint() {
        if(!document.getElementById('print-content').innerText.trim()) {
            alert("Ø§Ø¨ØªØ¯Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.");
            return;
        }
        window.print();
    }
</script>
</body>
</html>
