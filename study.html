<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¯ÙØªØ±Ú†Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ | Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø¯Ú©ØªØ± Ø§ÙØ´Ø§Ø±Ù…Ù†Ø´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        /* Ù„ÙˆØ¯ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ Ø§Ø² Ù¾ÙˆØ´Ù‡ fonts */
        @font-face {
            font-family: 'Doran';
            src: url('fonts/DoranFaNum-Light.ttf') format('truetype');
            font-weight: 300;
        }
        @font-face {
            font-family: 'Doran';
            src: url('fonts/DoranFaNum-Bold.ttf') format('truetype');
            font-weight: 700;
        }

        body { background-color: #f8f9fa; font-family: 'Doran', Tahoma, sans-serif; font-weight: 300; }
        .bold-text { font-weight: 700 !important; }
        .no-print { background: white; padding: 20px; border-bottom: 3px solid #007bff; position: sticky; top: 0; z-index: 100; }
        
        .page-container { 
            background: white; width: 210mm; min-height: 290mm; 
            margin: 20px auto; padding: 30px 45px; border: 1px solid #ddd;
            page-break-after: always; display: flex; flex-direction: column; justify-content: space-between;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1.5px solid #000; padding: 10px; text-align: center; vertical-align: middle; }
        th { background-color: #f8f9fa; }
        .bg-rest { background-color: #f0f7ff !important; }
        .bg-exam { background-color: #f2faf2 !important; }

        .stamp-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; border-top: 2px solid #333; padding-top: 15px; }
        .logo-img { width: 150px; height: auto; object-fit: contain; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page-container { margin: 0; border: none; width: 100%; height: auto; }
            @page { size: A4 portrait; margin: 5mm; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="container text-center">
        <h4 class="mb-3 bold-text">ØµØ¯ÙˆØ± Ø¯ÙØªØ±Ú†Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ Ø¢Ú©Ø§Ø¯Ù…ÛŒ</h4>
        <div class="row justify-content-center g-2">
            <div class="col-md-3">
                <input type="text" id="weekInput" class="form-control text-center fs-5" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù…Ø«Ù„Ø§Ù‹ 05)">
            </div>
            <div class="col-md-auto">
                <button class="btn btn-primary px-4 bold-text" onclick="loadWeeklyData()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
                <button class="btn btn-success px-4 bold-text" onclick="window.print()">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ø¯ÙØªØ±Ú†Ù‡</button>
            </div>
        </div>
    </div>
</div>

<div id="print-content"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby8NJAfUez3wCUiRXthdSuRT0thlXL_bPS2rDXGpcJhb25wdejrhKvMZ5DjxlZLv6Nh/exec";
    const LOGO_URL = "https://lh3.googleusercontent.com/u/0/d/1yD5HwxYqRXZUdiYrlHg_fM-SVvZC_1yB=w1000-h1000-iv1"; // Ù„ÛŒÙ†Ú© Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ
    const studentCode = "tahsili38";

    let allQuotes = [];

    // ØªØ§Ø¨Ø¹ Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¬Ù…Ù„Ø§Øª Ø§Ø² ÙØ§ÛŒÙ„ ØªÚ©Ø³Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨
    async function fetchQuotes() {
        try {
            const response = await fetch('quotes.txt');
            const text = await response.text();
            allQuotes = text.split('\n').filter(line => line.trim() !== "");
        } catch (e) {
            allQuotes = ["Ù¾ÛŒØ±ÙˆØ²ÛŒ Ø¯Ø± ØªØ¯Ø§ÙˆÙ… Ø§Ø³Øª."];
        }
    }

    async function loadWeeklyData() {
        const weekNum = document.getElementById('weekInput').value;
        if(!weekNum) return;
        
        await fetchQuotes(); // Ø§ÙˆÙ„ Ø¬Ù…Ù„Ø§Øª Ø±Ø§ Ø¨Ú¯ÛŒØ±
        document.getElementById('print-content').innerHTML = "<p class='text-center mt-5'>Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡...</p>";
        
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "getWeekPlan", studentCode: studentCode, weekNum: weekNum })
            });
            const result = await res.json();
            if(result.status === "success") renderPages(result.data, weekNum);
        } catch (e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±"); }
    }

    function renderPages(data, weekNum) {
        const container = document.getElementById('print-content');
        container.innerHTML = "";

        data.forEach((day) => {
            // Ø§Ù†ØªØ®Ø§Ø¨ ÛŒÚ© Ø¬Ù…Ù„Ù‡ ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ²
            const randomQuote = allQuotes.length > 0 ? allQuotes[Math.floor(Math.random() * allQuotes.length)] : "Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ø±Ø§Ø± ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú© Ø§Ø³Øª.";

            let html = `
                <div class="page-container">
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="bold-text">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ² ${day.dayName}</h2>
                            <div class="text-end">
                                <div class="bold-text">Ú©Ø¯ Ù…Ø±Ø§Ø¬Ø¹: ${studentCode}</div>
                                <div>ØªØ§Ø±ÛŒØ®: ${day.date} | Ù‡ÙØªÙ‡: ${weekNum}</div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr><th style="width:25%">Ø²Ù…Ø§Ù†</th><th>Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø·Ø§Ù„Ø¹Ù‡</th><th style="width:15%">ØªØ§ÛŒÛŒØ¯</th></tr>
                            </thead>
                            <tbody>`;

            let mergedTasks = [];
            for (let i = 0; i < day.tasks.length; i++) {
                let current = day.tasks[i];
                let startTime = current.time.split('-')[0];
                let endTime = current.time.split('-')[1] || "";
                let lesson = current.lesson;

                while (i + 1 < day.tasks.length && (day.tasks[i + 1].lesson === lesson || !day.tasks[i + 1].lesson) && lesson !== "") {
                    endTime = day.tasks[i + 1].time.split('-')[1] || day.tasks[i + 1].time;
                    i++;
                }
                mergedTasks.push({ time: `${startTime} - ${endTime}`, lesson: lesson });
            }

            mergedTasks.forEach(task => {
                let rowClass = "";
                if(task.lesson.includes("Ø§Ø³ØªØ±Ø§Ø­Øª")) rowClass = "bg-rest";
                if(task.lesson.includes("Ø¢Ø²Ù…ÙˆÙ†")) rowClass = "bg-exam";

                html += `
                    <tr class="${rowClass}">
                        <td class="bold-text">${task.time}</td>
                        <td>${task.lesson}</td>
                        <td>${task.lesson && !task.lesson.includes("Ø§Ø³ØªØ±Ø§Ø­Øª") ? "âœ”ï¸" : ""}</td>
                    </tr>`;
            });

            html += `</tbody></table>
                    </div>
                    <div class="stamp-footer">
                        <div style="max-width:70%">
                            <strong class="bold-text">Ø­Ø±Ù Ø±ÙˆØ²:</strong>
                            <p style="margin-top:5px; font-size:16px;">${randomQuote}</p>
                        </div>
                        <div class="text-center">
                            <img src="${LOGO_URL}" class="logo-img" onerror="this.src='https://raw.githubusercontent.com/ehsanafsharmanesh/ehsanafsharmanesh.github.io/main/newlogo.jpg'">
                            <div class="bold-text" style="font-size:12px; margin-top:5px;">Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø¯Ú©ØªØ± Ø§ÙØ´Ø§Ø±Ù…Ù†Ø´</div>
                        </div>
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }
</script>
</body>
</html>
